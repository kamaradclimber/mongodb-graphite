#!/usr/bin/env ruby

require 'mongodb-graphite'
require 'optparse'
require 'daemons'
require 'simple-graphite'

conf_dir = File.expand_path(ENV['MONGODB_GRAPHITE_DIR'] || '.')

config = MongodbGraphite::Configuration.new(conf_dir)

daemon_options = {
  :multiple => false,
  :monitor => true,
  :backtrace => true,
  :log_dir => config[:log_dir],
  :log_output => true,
  :dir_mode => :normal,
  :dir => config[:pid_dir]
}

g_host, g_port = config[:graphite].split(':')

[:log_dir, :pid_dir].each do |d|
  Dir.mkdir config[d] unless Dir.exist?(config[d])
end

Daemons.run_proc('mongodb-graphite', daemon_options) do
  loop do
    g = Graphite.new( :host => g_host, :port => g_port || '3333' )
    @instance_list = MongodbGraphite::InstanceList.new(config)
    @instance_list.each do |i|
      begin
        g.send_metrics(i.to_graphite)
      rescue Exception => e
        puts "Impossible to send metrics because of #{e}"
        puts e.backtrace
      end
    end
    sleep (config[:interval] || 5)
  end
end
